function [f,dfdx,d2fdx2] = neglogpost_recover(x,p,grd,M3d,dVt)

nip = length(x);

p.k1 = exp(x(1));
p.k2 = exp(x(2));
p.d1 = exp(x(3));
p.d2 = exp(x(4));

[M,D,D2] = Pcycle(p,grd,M3d);
Ps = M(1:24);Phs = M(25:48);Chls = M(49:72);
Pf = M(73:96);Phf = M(97:120);Chlf = M(121:144);
dVt = dVt(1:24);

W = repmat(dVt(:),6,1);
W = d0(W);

%W = d0(dVt(:)./sum(dVt(:)));

e1 = (Ps-p.Ps)/p.Psstd;
e2 = (Phs-p.Phs)/p.Phsstd;
e3 = (Chls-p.Chls)/p.Chlsstd;
e4 = (Pf-p.Pf)/p.Pfstd;
e5 = (Phf-p.Phf)/p.Phfstd;
e6 = (Chlf-p.Chlf)/p.Chlfstd;
e = [e1;e2;e3;e4;e5;e6];

%f = 0.5*(e1.'*W*e1+e2.'*W*e2+e3.'*W*e3+e4.'*W*e4+e5.'*W*e5+e6.'*W* ...
%         e6);%+0.00011*(ep.'*Wp*ep);
f = 0.5*e.'*W*e;
     D = [D(1:24,:)/p.Psstd;...
          D(25:48,:)/p.Phsstd;...
          D(49:72,:)/p.Chlsstd;...
          D(73:96,:)/p.Pfstd;...
          D(97:120,:)/p.Phfstd;...
          D(121:144,:)/p.Chlfstd];
 dpdx = diag(exp(x));
 dedx = D*dpdx;
 dfdx = e.'*W*dedx;
 D2 = [D2(1:24,:)/p.Psstd;...
       D2(25:48,:)/p.Phsstd;...
       D2(49:72,:)/p.Chlsstd;...
       D2(73:96,:)/p.Pfstd;...
       D2(97:120,:)/p.Phfstd;...
       D2(121:144,:)/p.Chlfstd];
 H(1,:) = e.'*W*(D2(:,1:4));
 H(2,:) = e.'*W*(D2(:,5:8));
 H(3,:) = e.'*W*(D2(:,9:12));
 H(4,:) = e.'*W*(D2(:,13:16));
 
 H = 0.5*dpdx*(H+H.')*dpdx+diag(e.'*W*dedx);
 d2fdx2 = dedx.'*W*dedx+H;

function [M,D,D2] = Pcycle(p,grd,M3d)

k1 = p.k1;
k2 = p.k2;
d1 = p.d1;
d2 = p.d2;

Ps0 = p.Ps0;
Pf0 = p.Pf0;
Phs0 = p.Phs0;
Phf0 = p.Phf0;
Chls0 = p.Chls0;
Chlf0 = p.Chlf0;
tmp = M3d;
tmp(:,:,4:end) = 0;
itop = find(tmp(:));

[PFdiv_s,dPFDdk1,dPFDdd2] = buildPFD_s(M3d,p,grd);
[PFdiv_f,dPFDdk2] = buildPFD_f(M3d,p,grd);
[PFdiv_c,dPFDdk1,dPFDdd1] = buildPFD_Chl(M3d,p,grd);
PFdiv_f = buildPFD_f(M3d,p,grd);
PFdiv_s(24,24) = PFdiv_s(23,23);
PFdiv_c(24,24) = PFdiv_c(23,23);
PFdiv_f(24,24) = PFdiv_f(23,23);

dPFDdk1(24,24) = dPFDdk1(23,23);
dPFDdk2(24,24) = dPFDdk2(23,23);
dPFDdd1(24,24) = dPFDdd1(23,23);
dPFDdd2(24,24) = dPFDdd2(23,23);

I = speye(length(Ps0));
rhs = [-Ps0;-Phs0;-Chls0;-Pf0;-Phf0;-Chlf0];

J = [[-(k1+d2)*I-PFdiv_s,0*I, 0*I,k2*I,0*I,0*I];...
     [0*I,-(k1+d2)*I-PFdiv_s,d1*I,0*I,k2*I,0*I];...
     [0*I,0*I,-(k1+d1)*I-PFdiv_c,0*I, 0*I,k2*I];...
     [k1*I,0*I,0*I,-k2*I-PFdiv_f,0*I,0*I];...
     [0*I,k1*I,0*I,0*I,-k2*I-PFdiv_f,0*I];...
     [0*I,0*I,k1*I,0*I,0*I,-k2*I-PFdiv_f]];

FJ = mfactor(J);
M = mfactor(FJ,rhs);

dJdk1 = [[-I-dPFDdk1,       0*I,       0*I,0*I,0*I,0*I];...
	 [       0*I,-I-dPFDdk1,       0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,-I-dPFDdk1,0*I,0*I,0*I];...	
	 [         I,       0*I,       0*I,0*I,0*I,0*I];...
	 [       0*I,         I,       0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,         I,0*I,0*I,0*I]];

dJdk2 = [[0*I,0*I,0*I,         I,       0*I,        0*I];...
	 [0*I,0*I,0*I,       0*I,         I,        0*I];...
	 [0*I,0*I,0*I,       0*I,       0*I,          I];...
	 [0*I,0*I,0*I,-I-dPFDdk2,       0*I,        0*I];...
	 [0*I,0*I,0*I,       0*I,-I-dPFDdk2,        0*I];...
	 [0*I,0*I,0*I,       0*I,       0*I,-I-dPFDdk2]];

dJdd1 = [[0*I,0*I,        0*I,0*I,0*I,0*I];...
	 [0*I,0*I,          I,0*I,0*I,0*I];...
	 [0*I,0*I, -I-dPFDdd1,0*I,0*I,0*I];...
	 [0*I,0*I,        0*I,0*I,0*I,0*I];...
	 [0*I,0*I,        0*I,0*I,0*I,0*I];...
	 [0*I,0*I,        0*I,0*I,0*I,0*I]];

dJdd2 = [[-I-dPFDdd2,       0*I,0*I,0*I,0*I,0*I];...
	 [       0*I,-I-dPFDdd2,0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,0*I,0*I,0*I,0*I];...
	 [       0*I,       0*I,0*I,0*I,0*I,0*I]];

D = mfactor(FJ,-[dJdk1*M,...
	         dJdk2*M,...
		 dJdd1*M,...
		 dJdd2*M]);

D2 = mfactor(FJ,[-2*dJdk1*D,...
	         -2*dJdk2*D,...
		 -2*dJdd1*D,...
		 -2*dJdd2*D]);

